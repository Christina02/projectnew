'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.checkString = checkString;
exports.check = check;

var _path = require('path');

var _fs = require('fs');

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _objectAssign = require('object-assign');

var _objectAssign2 = _interopRequireDefault(_objectAssign);

var _util = require('./util');

var _edpCore = require('edp-core');

var _config = require('./config');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @file checker 针对 css 文件的校验器
 * @author ielgnaw(wuji0223@gmail.com)
 */

'use strict';

/**
 * rule 逻辑实现的文件夹路径
 */
var ruleDir = (0, _path.join)(__dirname, './rule');

/**
 * 检测的默认配置
 *
 * @const
 * @type {Object}
 */
var DEFAULT_CONFIG = (0, _objectAssign2.default)({}, (0, _config.loadConfig)('.', true));

/**
 * 为 max-error 服务的，记录整个的错误个数
 *
 * @type {number}
 */
global.CSSHINT_INVALID_ALL_COUNT = 0;

/**
 * 记录项目级别的 font-family 大小写信息，key 为小写格式，value 为真实的值
 * {'arial': 'Arial'}
 *
 * @type {Object}
 */
global.CSSHINT_FONTFAMILY_CASE_FLAG = {};

/**
 * 匹配行内 csshint key: value, ... 的正则
 *
 * @const
 * @type {RegExp}
 */
var INLINE_PATTERN = /\/\*+\s*\bcsshint[^-disable]\b\s*(.*)\s*\*\//gmi;

/**
 * 分析行内注释
 *
 * @param {string} fileContent 当前检测的文件内容
 * @param {Object} rcConfig 当前检测的文件的检测规则
 *
 * @return {Object} inline Rule
 */
var analyzeInlineRule = function analyzeInlineRule(fileContent, rcConfig) {
    var ret = {};
    var inlineObj = null;
    var match = null;

    /* jshint loopfunc:true */
    /* eslint-disable no-extra-boolean-cast, no-loop-func */
    while (!!(match = INLINE_PATTERN.exec(fileContent))) {
        var matchRules = match[1];
        var jsonStr = matchRules.replace(/([^,]*)(?=:)/g, function (word) {
            if (word) {
                word = word.replace(/\s/g, '');
                return '"' + word + '"';
            }
            return '';
        });
        jsonStr = '{' + jsonStr + '}';

        try {
            inlineObj = JSON.parse(jsonStr);
        } catch (e) {}

        if (inlineObj) {
            /* eslint-disable fecs-use-for-of */
            for (var p in inlineObj) {
                if (rcConfig.hasOwnProperty(p)) {
                    ret[p] = inlineObj[p];
                }
            }
            /* eslint-enable fecs-use-for-of */
        }
    }
    /* eslint-enable no-extra-boolean-cast, no-loop-func */
    return ret;
};

/**
 * 匹配行内 csshint-disable xxx, yyy, zzz 的正则
 *
 * @const
 * @type {RegExp}
 */
var INLINE_DISABLE_PATTERN = /\/\*+\s*\bcsshint\-disable\b\s*([^\*\/]*)\s*\*\//gmi;

/**
 * 分析行内 disable 注释
 *
 * @param {string} fileContent 当前检测的文件内容
 * @param {Object} rcConfig 当前检测的文件的检测规则
 *
 * @return {Object} inline Rule
 */
var analyzeInlineDisableRule = function analyzeInlineDisableRule(fileContent, rcConfig) {
    var ret = {};
    var match = null;
    /* eslint-disable no-extra-boolean-cast */
    while (!!(match = INLINE_DISABLE_PATTERN.exec(fileContent))) {
        var matchedRules = match[1];
        if (matchedRules) {
            var simpleMatchedRules = matchedRules.split(/[^a-z-]/gmi);
            for (var i = 0, len = simpleMatchedRules.length; i < len; i++) {
                simpleMatchedRules[i] && (ret[(0, _util.trim)(simpleMatchedRules[i])] = false);
            }
        } else {
            /* eslint-disable fecs-use-for-of */
            for (var p in rcConfig) {
                if (rcConfig.hasOwnProperty(p)) {
                    ret[p] = false;
                }
            }
            /* eslint-enable fecs-use-for-of */
        }
    }
    /* eslint-enable no-extra-boolean-cast */
    return ret;
};

/**
 * 检测 css 文件内容
 *
 * @param {string} fileContent 文件内容
 * @param {string} filePath 文件路径
 * @param {Object=} rcConfig 检测规则的配置，可选
 *
 * @return {Promise} Promise 回调函数的参数即错误信息的集合 {ruleName, line, col, errorChar, message, colorMessage}
 */
function checkString(fileContent, filePath) {
    var rcConfig = arguments.length <= 2 || arguments[2] === undefined ? DEFAULT_CONFIG : arguments[2];


    global.CSSHINT_FONTFAMILY_CASE_FLAG = {};

    // 这里把文件内容的 \r\n 统一替换成 \n，便于之后获取行号
    fileContent = fileContent.replace(/\r\n?/g, '\n');

    // 行内注释改变规则配置
    var inline = analyzeInlineRule(fileContent, rcConfig);

    // 行内注释取消规则配置
    var inlineDisable = analyzeInlineDisableRule(fileContent, rcConfig);

    var realConfig = _edpCore.util.extend({}, rcConfig, inline, inlineDisable);

    var maxError = parseInt(realConfig['max-error'], 10);

    // maxError 为 0 或者非数字的情况，则表示忽略 maxError 即是最大值
    if (isNaN(maxError) || maxError === 0) {
        maxError = Number.MAX_VALUE;
    }

    // postcss 插件集合即规则检测的文件集合
    var plugins = [];

    Object.getOwnPropertyNames(realConfig).forEach(function (prop) {
        var ruleFilePath = (0, _path.join)(ruleDir, prop) + '.js';
        if ((0, _fs.existsSync)(ruleFilePath)) {
            plugins.push(require((0, _path.join)(ruleDir, prop)).check({
                ruleVal: realConfig[prop],
                // 实际上在 postcss 的 plugin 里面通过 node.source.input.css 也可以拿到文件内容
                // 但是通过这种方式拿到的内容是去掉 BOM 的，因此在检测 no-bom 规则时候会有问题
                // 所以这里把文件的原内容传入进去
                fileContent: fileContent,
                filePath: filePath,
                maxError: maxError
            }));
        }
    });

    // 不合法的信息集合
    var invalidList = [];

    var invalid = {
        path: '',
        messages: []
    };

    var checkPromise = new Promise(function (resolve, reject) {
        (0, _postcss2.default)(plugins).process(fileContent).then(function (result) {
            result.warnings().forEach(function (data) {
                invalid.messages.push({
                    ruleName: data.ruleName,
                    line: data.line,
                    col: data.col,
                    errorChar: data.errorChar || '',
                    message: data.message,
                    colorMessage: data.colorMessage
                });
                if (invalid.path !== filePath) {
                    invalid.path = filePath;
                    invalidList.push(invalid);
                }
            });
            resolve(invalidList);
        }).catch(function (e) {
            console.log('e: ', e);
            var line = e.line;
            // 根据 line 是否存在来判断是 css parse 的错误还是程序的错误
            /* istanbul ignore else */
            if (line) {
                var lineContent = (0, _util.getLineContent)(e.line, fileContent) || '';
                invalid.messages.push({
                    line: e.line,
                    col: e.column,
                    message: '' + 'CssSyntaxError: ' + e.message,
                    colorMessage: '' + _chalk2.default.red('CssSyntaxError <' + e.reason + '>: ') + _chalk2.default.grey((0, _util.changeColorByIndex)(lineContent, 0, lineContent.substring(0, e.column - 1)))
                });
            } else {
                var str = e.toString();
                invalid.messages.push({
                    message: str,
                    colorMessage: _chalk2.default.red(str)
                });
            }

            if (invalid.path !== filePath) {
                invalid.path = filePath;
                invalidList.push(invalid);
            }

            reject(invalidList);
        });
    });

    return checkPromise;
}

/**
 * 校验文件
 *
 * @param {Object} file 包含 path, content 键的对象
 * @param {Array} errors 本分类的错误信息数组
 * @param {Function} done 校验完成的通知回调
 *
 * @return {Function} checkString
 */
function check(file, errors, done) {
    // .csshintignore 中配置的文件是指可以忽略 csshint 的文件
    if ((0, _util.isIgnored)(file.path, '.csshintignore')) {
        done();
        return;
    }

    /**
     * checkString 的 promise 的 reject 和 resolve 的返回值的结构以及处理方式都是一样的
     * reject 指的是 CssSyntaxError 的错误。
     * resolve 代表的是 csshint 检测出来的问题
     *
     * @param {Array.<Object>} invalidList 错误信息集合
     */
    var callback = function callback(invalidList) {
        if (invalidList.length) {
            invalidList.forEach(function (invalid) {
                errors.push({
                    path: invalid.path,
                    messages: invalid.messages
                });
            });
        }
        done();
    };

    return checkString(file.content, file.path, (0, _objectAssign2.default)({}, (0, _config.loadConfig)(file.path, true))).then(callback).catch(callback);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jaGVja2VyLmpzIl0sIm5hbWVzIjpbImNoZWNrU3RyaW5nIiwiY2hlY2siLCJydWxlRGlyIiwiX19kaXJuYW1lIiwiREVGQVVMVF9DT05GSUciLCJnbG9iYWwiLCJDU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UIiwiQ1NTSElOVF9GT05URkFNSUxZX0NBU0VfRkxBRyIsIklOTElORV9QQVRURVJOIiwiYW5hbHl6ZUlubGluZVJ1bGUiLCJmaWxlQ29udGVudCIsInJjQ29uZmlnIiwicmV0IiwiaW5saW5lT2JqIiwibWF0Y2giLCJleGVjIiwibWF0Y2hSdWxlcyIsImpzb25TdHIiLCJyZXBsYWNlIiwid29yZCIsIkpTT04iLCJwYXJzZSIsImUiLCJwIiwiaGFzT3duUHJvcGVydHkiLCJJTkxJTkVfRElTQUJMRV9QQVRURVJOIiwiYW5hbHl6ZUlubGluZURpc2FibGVSdWxlIiwibWF0Y2hlZFJ1bGVzIiwic2ltcGxlTWF0Y2hlZFJ1bGVzIiwic3BsaXQiLCJpIiwibGVuIiwibGVuZ3RoIiwiZmlsZVBhdGgiLCJpbmxpbmUiLCJpbmxpbmVEaXNhYmxlIiwicmVhbENvbmZpZyIsImV4dGVuZCIsIm1heEVycm9yIiwicGFyc2VJbnQiLCJpc05hTiIsIk51bWJlciIsIk1BWF9WQUxVRSIsInBsdWdpbnMiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwiZm9yRWFjaCIsInJ1bGVGaWxlUGF0aCIsInByb3AiLCJwdXNoIiwicmVxdWlyZSIsInJ1bGVWYWwiLCJpbnZhbGlkTGlzdCIsImludmFsaWQiLCJwYXRoIiwibWVzc2FnZXMiLCJjaGVja1Byb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInByb2Nlc3MiLCJ0aGVuIiwicmVzdWx0Iiwid2FybmluZ3MiLCJydWxlTmFtZSIsImRhdGEiLCJsaW5lIiwiY29sIiwiZXJyb3JDaGFyIiwibWVzc2FnZSIsImNvbG9yTWVzc2FnZSIsImNhdGNoIiwiY29uc29sZSIsImxvZyIsImxpbmVDb250ZW50IiwiY29sdW1uIiwicmVkIiwicmVhc29uIiwiZ3JleSIsInN1YnN0cmluZyIsInN0ciIsInRvU3RyaW5nIiwiZmlsZSIsImVycm9ycyIsImRvbmUiLCJjYWxsYmFjayIsImNvbnRlbnQiXSwibWFwcGluZ3MiOiI7Ozs7O1FBc0pnQkEsVyxHQUFBQSxXO1FBc0hBQyxLLEdBQUFBLEs7O0FBdlFoQjs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7OztBQWJBOzs7OztBQWdCQTs7QUFFQTs7O0FBR0EsSUFBTUMsVUFBVSxnQkFBS0MsU0FBTCxFQUFnQixRQUFoQixDQUFoQjs7QUFFQTs7Ozs7O0FBTUEsSUFBTUMsaUJBQWlCLDRCQUFhLEVBQWIsRUFBaUIsd0JBQVcsR0FBWCxFQUFnQixJQUFoQixDQUFqQixDQUF2Qjs7QUFFQTs7Ozs7QUFLQUMsT0FBT0MseUJBQVAsR0FBbUMsQ0FBbkM7O0FBRUE7Ozs7OztBQU1BRCxPQUFPRSw0QkFBUCxHQUFzQyxFQUF0Qzs7QUFFQTs7Ozs7O0FBTUEsSUFBTUMsaUJBQWlCLGlEQUF2Qjs7QUFFQTs7Ozs7Ozs7QUFRQSxJQUFNQyxvQkFBb0IsU0FBcEJBLGlCQUFvQixDQUFDQyxXQUFELEVBQWNDLFFBQWQsRUFBMkI7QUFDakQsUUFBTUMsTUFBTSxFQUFaO0FBQ0EsUUFBSUMsWUFBWSxJQUFoQjtBQUNBLFFBQUlDLFFBQVEsSUFBWjs7QUFFQTtBQUNBO0FBQ0EsV0FBTyxDQUFDLEVBQUVBLFFBQVFOLGVBQWVPLElBQWYsQ0FBb0JMLFdBQXBCLENBQVYsQ0FBUixFQUFxRDtBQUNqRCxZQUFNTSxhQUFhRixNQUFNLENBQU4sQ0FBbkI7QUFDQSxZQUFJRyxVQUFVRCxXQUFXRSxPQUFYLENBQW1CLGVBQW5CLEVBQW9DLGdCQUFRO0FBQ3RELGdCQUFJQyxJQUFKLEVBQVU7QUFDTkEsdUJBQU9BLEtBQUtELE9BQUwsQ0FBYSxLQUFiLEVBQW9CLEVBQXBCLENBQVA7QUFDQSx1QkFBTyxNQUFNQyxJQUFOLEdBQWEsR0FB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SzVCLElBQWYsRUFBcUIsZ0JBQXJCLENBQUosRUFBNEM7QUFDeEM4QjtBQUNBO0FBQ0g7O0FBRUQ7Ozs7Ozs7QUFPQSxRQUFNQyxXQUFXLFNBQVhBLFFBQVcsY0FBZTtBQUM1QixZQUFJakMsWUFBWXBCLE1BQWhCLEVBQXdCO0FBQ3BCb0Isd0JBQVlOLE9BQVosQ0FBb0IsbUJBQVc7QUFDM0JxQyx1QkFBT2xDLElBQVAsQ0FBWTtBQUNSSywwQkFBTUQsUUFBUUMsSUFETjtBQUVSQyw4QkFBVUYsUUFBUUU7QUFGVixpQkFBWjtBQUlILGFBTEQ7QUFNSDtBQUNENkI7QUFDSCxLQVZEOztBQVlBLFdBQU9wRixZQUNIa0YsS0FBS0ksT0FERixFQUVISixLQUFLNUIsSUFGRixFQUdILDRCQUFhLEVBQWIsRUFBaUIsd0JBQVc0QixLQUFLNUIsSUFBaEIsRUFBc0IsSUFBdEIsQ0FBakIsQ0FIRyxFQUlMTyxJQUpLLENBSUF3QixRQUpBLEVBSVVkLEtBSlYsQ0FJZ0JjLFFBSmhCLENBQVA7QUFLSCIsImZpbGUiOiJjaGVja2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBjaGVja2VyIOmSiOWvuSBjc3Mg5paH5Lu255qE5qCh6aqM5ZmoXG4gKiBAYXV0aG9yIGllbGduYXcod3VqaTAyMjNAZ21haWwuY29tKVxuICovXG5cbmltcG9ydCB7am9pbn0gZnJvbSAncGF0aCc7XG5pbXBvcnQge2V4aXN0c1N5bmN9IGZyb20gJ2ZzJztcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgcG9zdGNzcyBmcm9tICdwb3N0Y3NzJztcbmltcG9ydCBvYmplY3RBc3NpZ24gZnJvbSAnb2JqZWN0LWFzc2lnbic7XG5cbmltcG9ydCB7aXNJZ25vcmVkLCB0cmltLCBnZXRMaW5lQ29udGVudCwgY2hhbmdlQ29sb3JCeUluZGV4fSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHt1dGlsIGFzIGVkcFV0aWx9IGZyb20gJ2VkcC1jb3JlJztcbmltcG9ydCB7bG9hZENvbmZpZ30gZnJvbSAnLi9jb25maWcnO1xuXG5cbid1c2Ugc3RyaWN0JztcblxuLyoqXG4gKiBydWxlIOmAu+i+keWunueOsOeahOaWh+S7tuWkuei3r+W+hFxuICovXG5jb25zdCBydWxlRGlyID0gam9pbihfX2Rpcm5hbWUsICcuL3J1bGUnKTtcblxuLyoqXG4gKiDmo4DmtYvnmoTpu5jorqTphY3nva5cbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtPYmplY3R9XG4gKi9cbmNvbnN0IERFRkFVTFRfQ09ORklHID0gb2JqZWN0QXNzaWduKHt9LCBsb2FkQ29uZmlnKCcuJywgdHJ1ZSkpO1xuXG4vKipcbiAqIOS4uiBtYXgtZXJyb3Ig5pyN5Yqh55qE77yM6K6w5b2V5pW05Liq55qE6ZSZ6K+v5Liq5pWwXG4gKlxuICogQHR5cGUge251bWJlcn1cbiAqL1xuZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQgPSAwO1xuXG4vKipcbiAqIOiusOW9lemhueebrue6p+WIq+eahCBmb250LWZhbWlseSDlpKflsI/lhpnkv6Hmga/vvIxrZXkg5Li65bCP5YaZ5qC85byP77yMdmFsdWUg5Li655yf5a6e55qE5YC8XG4gKiB7J2FyaWFsJzogJ0FyaWFsJ31cbiAqXG4gKiBAdHlwZSB7T2JqZWN0fVxuICovXG5nbG9iYWwuQ1NTSElOVF9GT05URkFNSUxZX0NBU0VfRkxBRyA9IHt9O1xuXG4vKipcbiAqIOWMuemFjeihjOWGhSBjc3NoaW50IGtleTogdmFsdWUsIC4uLiDnmoTmraPliJlcbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtSZWdFeHB9XG4gKi9cbmNvbnN0IElOTElORV9QQVRURVJOID0gL1xcL1xcKitcXHMqXFxiY3NzaGludFteLWRpc2FibGVdXFxiXFxzKiguKilcXHMqXFwqXFwvL2dtaTtcblxuLyoqXG4gKiDliIbmnpDooYzlhoXms6jph4pcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZUNvbnRlbnQg5b2T5YmN5qOA5rWL55qE5paH5Lu25YaF5a65XG4gKiBAcGFyYW0ge09iamVjdH0gcmNDb25maWcg5b2T5YmN5qOA5rWL55qE5paH5Lu255qE5qOA5rWL6KeE5YiZXG4gKlxuICogQHJldHVybiB7T2JqZWN0fSBpbmxpbmUgUnVsZVxuICovXG5jb25zdCBhbmFseXplSW5saW5lUnVsZSA9IChmaWxlQ29udGVudCwgcmNDb25maWcpID0+IHtcbiAgICBjb25zdCByZXQgPSB7fTtcbiAgICBsZXQgaW5saW5lT2JqID0gbnVsbDtcbiAgICBsZXQgbWF0Y2ggPSBudWxsO1xuXG4gICAgLyoganNoaW50IGxvb3BmdW5jOnRydWUgKi9cbiAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1leHRyYS1ib29sZWFuLWNhc3QsIG5vLWxvb3AtZnVuYyAqL1xuICAgIHdoaWxlICghIShtYXRjaCA9IElOTElORV9QQVRURVJOLmV4ZWMoZmlsZUNvbnRlbnQpKSkge1xuICAgICAgICBjb25zdCBtYXRjaFJ1bGVzID0gbWF0Y2hbMV07XG4gICAgICAgIGxldCBqc29uU3RyID0gbWF0Y2hSdWxlcy5yZXBsYWNlKC8oW14sXSopKD89OikvZywgd29yZCA9PiB7XG4gICAgICAgICAgICBpZiAod29yZCkge1xuICAgICAgICAgICAgICAgIHdvcmQgPSB3b3JkLnJlcGxhY2UoL1xccy9nLCAnJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuICdcIicgKyB3b3JkICsgJ1wiJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfSk7XG4gICAgICAgIGpzb25TdHIgPSAneycgKyBqc29uU3RyICsgJ30nO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpbmxpbmVPYmogPSBKU09OLnBhcnNlKGpzb25TdHIpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7fVxuXG4gICAgICAgIGlmIChpbmxpbmVPYmopIHtcbiAgICAgICAgICAgIC8qIGVzbGludC1kaXNhYmxlIGZlY3MtdXNlLWZvci1vZiAqL1xuICAgICAgICAgICAgZm9yIChjb25zdCBwIGluIGlubGluZU9iaikge1xuICAgICAgICAgICAgICAgIGlmIChyY0NvbmZpZy5oYXNPd25Qcm9wZXJ0eShwKSkge1xuICAgICAgICAgICAgICAgICAgICByZXRbcF0gPSBpbmxpbmVPYmpbcF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLyogZXNsaW50LWVuYWJsZSBmZWNzLXVzZS1mb3Itb2YgKi9cbiAgICAgICAgfVxuICAgIH1cbiAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLWV4dHJhLWJvb2xlYW4tY2FzdCwgbm8tbG9vcC1mdW5jICovXG4gICAgcmV0dXJuIHJldDtcbn07XG5cbi8qKlxuICog5Yy56YWN6KGM5YaFIGNzc2hpbnQtZGlzYWJsZSB4eHgsIHl5eSwgenp6IOeahOato+WImVxuICpcbiAqIEBjb25zdFxuICogQHR5cGUge1JlZ0V4cH1cbiAqL1xuY29uc3QgSU5MSU5FX0RJU0FCTEVfUEFUVEVSTiA9IC9cXC9cXCorXFxzKlxcYmNzc2hpbnRcXC1kaXNhYmxlXFxiXFxzKihbXlxcKlxcL10qKVxccypcXCpcXC8vZ21pO1xuXG4vKipcbiAqIOWIhuaekOihjOWGhSBkaXNhYmxlIOazqOmHilxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlQ29udGVudCDlvZPliY3mo4DmtYvnmoTmlofku7blhoXlrrlcbiAqIEBwYXJhbSB7T2JqZWN0fSByY0NvbmZpZyDlvZPliY3mo4DmtYvnmoTmlofku7bnmoTmo4DmtYvop4TliJlcbiAqXG4gKiBAcmV0dXJuIHtPYmplY3R9IGlubGluZSBSdWxlXG4gKi9cbmNvbnN0IGFuYWx5emVJbmxpbmVEaXNhYmxlUnVsZSA9IChmaWxlQ29udGVudCwgcmNDb25maWcpID0+IHtcbiAgICBjb25zdCByZXQgPSB7fTtcbiAgICBsZXQgbWF0Y2ggPSBudWxsO1xuICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLWV4dHJhLWJvb2xlYW4tY2FzdCAqL1xuICAgIHdoaWxlICghIShtYXRjaCA9IElOTElORV9ESVNBQkxFX1BBVFRFUk4uZXhlYyhmaWxlQ29udGVudCkpKSB7XG4gICAgICAgIGNvbnN0IG1hdGNoZWRSdWxlcyA9IG1hdGNoWzFdO1xuICAgICAgICBpZiAobWF0Y2hlZFJ1bGVzKSB7XG4gICAgICAgICAgICBjb25zdCBzaW1wbGVNYXRjaGVkUnVsZXMgPSBtYXRjaGVkUnVsZXMuc3BsaXQoL1teYS16LV0vZ21pKTtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBzaW1wbGVNYXRjaGVkUnVsZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICBzaW1wbGVNYXRjaGVkUnVsZXNbaV0gJiYgKHJldFt0cmltKHNpbXBsZU1hdGNoZWRSdWxlc1tpXSldID0gZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgLyogZXNsaW50LWRpc2FibGUgZmVjcy11c2UtZm9yLW9mICovXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHAgaW4gcmNDb25maWcpIHtcbiAgICAgICAgICAgICAgICBpZiAocmNDb25maWcuaGFzT3duUHJvcGVydHkocCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0W3BdID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLyogZXNsaW50LWVuYWJsZSBmZWNzLXVzZS1mb3Itb2YgKi9cbiAgICAgICAgfVxuICAgIH1cbiAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLWV4dHJhLWJvb2xlYW4tY2FzdCAqL1xuICAgIHJldHVybiByZXQ7XG59O1xuXG4vKipcbiAqIOajgOa1iyBjc3Mg5paH5Lu25YaF5a65XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVDb250ZW50IOaWh+S7tuWGheWuuVxuICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoIOaWh+S7tui3r+W+hFxuICogQHBhcmFtIHtPYmplY3Q9fSByY0NvbmZpZyDmo4DmtYvop4TliJnnmoTphY3nva7vvIzlj6/pgIlcbiAqXG4gKiBAcmV0dXJuIHtQcm9taXNlfSBQcm9taXNlIOWbnuiwg+WHveaVsOeahOWPguaVsOWNs+mUmeivr+S/oeaBr+eahOmbhuWQiCB7cnVsZU5hbWUsIGxpbmUsIGNvbCwgZXJyb3JDaGFyLCBtZXNzYWdlLCBjb2xvck1lc3NhZ2V9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjaGVja1N0cmluZyhmaWxlQ29udGVudCwgZmlsZVBhdGgsIHJjQ29uZmlnID0gREVGQVVMVF9DT05GSUcpIHtcblxuICAgIGdsb2JhbC5DU1NISU5UX0ZPTlRGQU1JTFlfQ0FTRV9GTEFHID0ge307XG5cbiAgICAvLyDov5nph4zmiormlofku7blhoXlrrnnmoQgXFxyXFxuIOe7n+S4gOabv+aNouaIkCBcXG7vvIzkvr/kuo7kuYvlkI7ojrflj5booYzlj7dcbiAgICBmaWxlQ29udGVudCA9IGZpbGVDb250ZW50LnJlcGxhY2UoL1xcclxcbj8vZywgJ1xcbicpO1xuXG4gICAgLy8g6KGM5YaF5rOo6YeK5pS55Y+Y6KeE5YiZ6YWN572uXG4gICAgY29uc3QgaW5saW5lID0gYW5hbHl6ZUlubGluZVJ1bGUoZmlsZUNvbnRlbnQsIHJjQ29uZmlnKTtcblxuICAgIC8vIOihjOWGheazqOmHiuWPlua2iOinhOWImemFjee9rlxuICAgIGNvbnN0IGlubGluZURpc2FibGUgPSBhbmFseXplSW5saW5lRGlzYWJsZVJ1bGUoZmlsZUNvbnRlbnQsIHJjQ29uZmlnKTtcblxuICAgIGNvbnN0IHJlYWxDb25maWcgPSBlZHBVdGlsLmV4dGVuZCh7fSwgcmNDb25maWcsIGlubGluZSwgaW5saW5lRGlzYWJsZSk7XG5cbiAgICBsZXQgbWF4RXJyb3IgPSBwYXJzZUludChyZWFsQ29uZmlnWydtYXgtZXJyb3InXSwgMTApO1xuXG4gICAgLy8gbWF4RXJyb3Ig5Li6IDAg5oiW6ICF6Z2e5pWw5a2X55qE5oOF5Ya177yM5YiZ6KGo56S65b+955WlIG1heEVycm9yIOWNs+aYr+acgOWkp+WAvFxuICAgIGlmIChpc05hTihtYXhFcnJvcikgfHwgbWF4RXJyb3IgPT09IDApIHtcbiAgICAgICAgbWF4RXJyb3IgPSBOdW1iZXIuTUFYX1ZBTFVFO1xuICAgIH1cblxuICAgIC8vIHBvc3Rjc3Mg5o+S5Lu26ZuG5ZCI5Y2z6KeE5YiZ5qOA5rWL55qE5paH5Lu26ZuG5ZCIXG4gICAgY29uc3QgcGx1Z2lucyA9IFtdO1xuXG4gICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoXG4gICAgICAgIHJlYWxDb25maWdcbiAgICApLmZvckVhY2gocHJvcCA9PiB7XG4gICAgICAgIGNvbnN0IHJ1bGVGaWxlUGF0aCA9IGpvaW4ocnVsZURpciwgcHJvcCkgKyAnLmpzJztcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMocnVsZUZpbGVQYXRoKSkge1xuICAgICAgICAgICAgcGx1Z2lucy5wdXNoKFxuICAgICAgICAgICAgICAgIHJlcXVpcmUoam9pbihydWxlRGlyLCBwcm9wKSkuY2hlY2soe1xuICAgICAgICAgICAgICAgICAgICBydWxlVmFsOiByZWFsQ29uZmlnW3Byb3BdLFxuICAgICAgICAgICAgICAgICAgICAvLyDlrp7pmYXkuIrlnKggcG9zdGNzcyDnmoQgcGx1Z2luIOmHjOmdoumAmui/hyBub2RlLnNvdXJjZS5pbnB1dC5jc3Mg5Lmf5Y+v5Lul5ou/5Yiw5paH5Lu25YaF5a65XG4gICAgICAgICAgICAgICAgICAgIC8vIOS9huaYr+mAmui/h+i/meenjeaWueW8j+aLv+WIsOeahOWGheWuueaYr+WOu+aOiSBCT00g55qE77yM5Zug5q2k5Zyo5qOA5rWLIG5vLWJvbSDop4TliJnml7blgJnkvJrmnInpl67pophcbiAgICAgICAgICAgICAgICAgICAgLy8g5omA5Lul6L+Z6YeM5oqK5paH5Lu255qE5Y6f5YaF5a655Lyg5YWl6L+b5Y67XG4gICAgICAgICAgICAgICAgICAgIGZpbGVDb250ZW50OiBmaWxlQ29udGVudCxcbiAgICAgICAgICAgICAgICAgICAgZmlsZVBhdGg6IGZpbGVQYXRoLFxuICAgICAgICAgICAgICAgICAgICBtYXhFcnJvcjogbWF4RXJyb3JcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8g5LiN5ZCI5rOV55qE5L+h5oGv6ZuG5ZCIXG4gICAgY29uc3QgaW52YWxpZExpc3QgPSBbXTtcblxuICAgIGNvbnN0IGludmFsaWQgPSB7XG4gICAgICAgIHBhdGg6ICcnLFxuICAgICAgICBtZXNzYWdlczogW11cbiAgICB9O1xuXG4gICAgY29uc3QgY2hlY2tQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBwb3N0Y3NzKHBsdWdpbnMpLnByb2Nlc3MoZmlsZUNvbnRlbnQpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgIHJlc3VsdC53YXJuaW5ncygpLmZvckVhY2goZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgaW52YWxpZC5tZXNzYWdlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgcnVsZU5hbWU6IGRhdGEucnVsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGxpbmU6IGRhdGEubGluZSxcbiAgICAgICAgICAgICAgICAgICAgY29sOiBkYXRhLmNvbCxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3JDaGFyOiBkYXRhLmVycm9yQ2hhciB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZGF0YS5tZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6IGRhdGEuY29sb3JNZXNzYWdlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYgKGludmFsaWQucGF0aCAhPT0gZmlsZVBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgaW52YWxpZC5wYXRoID0gZmlsZVBhdGg7XG4gICAgICAgICAgICAgICAgICAgIGludmFsaWRMaXN0LnB1c2goaW52YWxpZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXNvbHZlKGludmFsaWRMaXN0KTtcbiAgICAgICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnZTogJywgZSk7XG4gICAgICAgICAgICBjb25zdCBsaW5lID0gZS5saW5lO1xuICAgICAgICAgICAgLy8g5qC55o2uIGxpbmUg5piv5ZCm5a2Y5Zyo5p2l5Yik5pat5pivIGNzcyBwYXJzZSDnmoTplJnor6/ov5jmmK/nqIvluo/nmoTplJnor69cbiAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovXG4gICAgICAgICAgICBpZiAobGluZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxpbmVDb250ZW50ID0gZ2V0TGluZUNvbnRlbnQoZS5saW5lLCBmaWxlQ29udGVudCkgfHwgJyc7XG4gICAgICAgICAgICAgICAgaW52YWxpZC5tZXNzYWdlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbGluZTogZS5saW5lLFxuICAgICAgICAgICAgICAgICAgICBjb2w6IGUuY29sdW1uLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKyAnQ3NzU3ludGF4RXJyb3I6ICdcbiAgICAgICAgICAgICAgICAgICAgICAgICsgZS5tZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6ICcnXG4gICAgICAgICAgICAgICAgICAgICAgICArIGNoYWxrLnJlZCgnQ3NzU3ludGF4RXJyb3IgPCcgKyBlLnJlYXNvbiArICc+OiAnKVxuICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFsay5ncmV5KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZUNvbG9yQnlJbmRleChsaW5lQ29udGVudCwgMCwgbGluZUNvbnRlbnQuc3Vic3RyaW5nKDAsIGUuY29sdW1uIC0gMSkpXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdHIgPSBlLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgaW52YWxpZC5tZXNzYWdlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogc3RyLFxuICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6IGNoYWxrLnJlZChzdHIpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpbnZhbGlkLnBhdGggIT09IGZpbGVQYXRoKSB7XG4gICAgICAgICAgICAgICAgaW52YWxpZC5wYXRoID0gZmlsZVBhdGg7XG4gICAgICAgICAgICAgICAgaW52YWxpZExpc3QucHVzaChpbnZhbGlkKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVqZWN0KGludmFsaWRMaXN0KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gY2hlY2tQcm9taXNlO1xufVxuXG4vKipcbiAqIOagoemqjOaWh+S7tlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBmaWxlIOWMheWQqyBwYXRoLCBjb250ZW50IOmUrueahOWvueixoVxuICogQHBhcmFtIHtBcnJheX0gZXJyb3JzIOacrOWIhuexu+eahOmUmeivr+S/oeaBr+aVsOe7hFxuICogQHBhcmFtIHtGdW5jdGlvbn0gZG9uZSDmoKHpqozlrozmiJDnmoTpgJrnn6Xlm57osINcbiAqXG4gKiBAcmV0dXJuIHtGdW5jdGlvbn0gY2hlY2tTdHJpbmdcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrKGZpbGUsIGVycm9ycywgZG9uZSkge1xuICAgIC8vIC5jc3NoaW50aWdub3JlIOS4remFjee9rueahOaWh+S7tuaYr+aMh+WPr+S7peW/veeVpSBjc3NoaW50IOeahOaWh+S7tlxuICAgIGlmIChpc0lnbm9yZWQoZmlsZS5wYXRoLCAnLmNzc2hpbnRpZ25vcmUnKSkge1xuICAgICAgICBkb25lKCk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBjaGVja1N0cmluZyDnmoQgcHJvbWlzZSDnmoQgcmVqZWN0IOWSjCByZXNvbHZlIOeahOi/lOWbnuWAvOeahOe7k+aehOS7peWPiuWkhOeQhuaWueW8j+mDveaYr+S4gOagt+eahFxuICAgICAqIHJlamVjdCDmjIfnmoTmmK8gQ3NzU3ludGF4RXJyb3Ig55qE6ZSZ6K+v44CCXG4gICAgICogcmVzb2x2ZSDku6PooajnmoTmmK8gY3NzaGludCDmo4DmtYvlh7rmnaXnmoTpl67pophcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7QXJyYXkuPE9iamVjdD59IGludmFsaWRMaXN0IOmUmeivr+S/oeaBr+mbhuWQiFxuICAgICAqL1xuICAgIGNvbnN0IGNhbGxiYWNrID0gaW52YWxpZExpc3QgPT4ge1xuICAgICAgICBpZiAoaW52YWxpZExpc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICBpbnZhbGlkTGlzdC5mb3JFYWNoKGludmFsaWQgPT4ge1xuICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgcGF0aDogaW52YWxpZC5wYXRoLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlczogaW52YWxpZC5tZXNzYWdlc1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZG9uZSgpO1xuICAgIH07XG5cbiAgICByZXR1cm4gY2hlY2tTdHJpbmcoXG4gICAgICAgIGZpbGUuY29udGVudCxcbiAgICAgICAgZmlsZS5wYXRoLFxuICAgICAgICBvYmplY3RBc3NpZ24oe30sIGxvYWRDb25maWcoZmlsZS5wYXRoLCB0cnVlKSlcbiAgICApLnRoZW4oY2FsbGJhY2spLmNhdGNoKGNhbGxiYWNrKTtcbn1cbiJdfQ==